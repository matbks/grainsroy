sap.ui.define([                                                                                                                                                                                                                                                
    "./BaseController",                                                                                                                                                                                                                                        
    "sap/ui/model/json/JSONModel",                                                                                                                                                                                                                             
    "../model/formatter",                                                                                                                                                                                                                                      
    "../model/models",                                                                                                                                                                                                                                         
    "sap/ui/model/Filter",                                                                                                                                                                                                                                     
    "sap/ui/model/FilterOperator",                                                                                                                                                                                                                             
    "sap/m/MessageBox",                                                                                                                                                                                                                                        
    "sap/ui/model/Sorter",                                                                                                                                                                                                                                     
    "sap/ui/core/Fragment",                                                                                                                                                                                                                                    
    "sap/m/MessageToast",                                                                                                                                                                                                                                      
], function (                                                                                                                                                                                                                                                  
    BaseController,                                                                                                                                                                                                                                            
    JSONModel,                                                                                                                                                                                                                                                 
    formatter,                                                                                                                                                                                                                                                 
    models,                                                                                                                                                                                                                                                    
    Filter,                                                                                                                                                                                                                                                    
    FilterOperator,                                                                                                                                                                                                                                            
    MessageBox,                                                                                                                                                                                                                                                
    Sorter,                                                                                                                                                                                                                                                    
    Fragment,                                                                                                                                                                                                                                                  
    MessageToast                                                                                                                                                                                                                                               
) {                                                                                                                                                                                                                                                            
    "use strict";                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    return BaseController.extend("grains.zadograinsacmcontrolling.controller.SalesContractFixation", {                                                                                                                                                         
        /**                                                                                                                                                                                                                                                    
         * @override                                                                                                                                                                                                                                           
         */                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
        formatter: formatter,                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
        onInit: function () {                                                                                                                                                                                                                                  
            this.initMessageProcessor()                                                                                                                                                                                                                        
            this.getRouter().attachRoutePatternMatched(this._onObjectMathed, this)                                                                                                                                                                             
        },                                                                                                                                                                                                                                                     
        _onObjectMathed: function (oEvent) {                                                                                                                                                                                                                   
            this._Fixation = oEvent.getParameter("arguments").Fixation                                                                                                                                                                                         
            debugger                                                                                                                                                                                                                                           
            if (!this._Fixation) {                                                                                                                                                                                                                             
                this._newFixation()                                                                                                                                                                                                                            
            } else {                                                                                                                                                                                                                                           
                this._getFixation(this._Fixation)                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
            this._refreshViewData()                                                                                                                                                                                                                            
        },                                                                                                                                                                                                                                                     
        _newFixation: function () {                                                                                                                                                                                                                            
            this.getModel().read(this.getStorage("SelectedPath").Path, {                                                                                                                                                                                       
                success: function (oData) {                                                                                                                                                                                                                    
                    this.getOwnerComponent().setModel(new JSONModel(oData), "ContractDetailsModel")                                                                                                                                                            
                    this.byId("SalesContractFixationCreationPage").setVisible(true)                                                                                                                                                                            
                    this.byId("SalesContractFixationDetailPage").setVisible(false)                                                                                                                                                                             
                }.bind(this),                                                                                                                                                                                                                                  
                error: function () {                                                                                                                                                                                                                           
                    MessageToast.show("Falha ao obter dados do contrato")                                                                                                                                                                                      
                }                                                                                                                                                                                                                                              
            })                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            this._applicationsListInitialization()                                                                                                                                                                                                             
        },                                                                                                                                                                                                                                                     
        _getFixation: function (Fixation) {                                                                                                                                                                                                                    
            this.byId("SalesContractFixationCreationPage").setVisible(false)                                                                                                                                                                                   
            this.byId("SalesContractFixationDetailPage").setVisible(true)                                                                                                                                                                                      
            this.getView().bindElement(this.getStorage("Fixation").sPath)                                                                                                                                                                                      
        },                                                                                                                                                                                                                                                     
        _applicationsListInitialization: function () {                                                                                                                                                                                                         
            this._oContext = new sap.ui.model.Context(this.getOwnerComponent().getModel(), this.getStorage("SelectedPath").Path)                                                                                                                               
            this.byId("SalesApplicationsSmartList").setBindingContext(this._oContext)                                                                                                                                                                          
            this.byId("SalesApplicationsSmartList").getList().removeSelections()                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
        onSelectApplication: function (oEvent) {                                                                                                                                                                                                               
            if (this.getOwnerComponent().getModel("Fixation").getData().Quantity > 0) {                                                                                                                                                                        
                var ApplicationEvent = oEvent.oSource._aSelectedPaths[0]                                                                                                                                                                                       
                MessageBox.show("Ao alterar o centro os dados da fixação serão perdidos, deseja continuar?", {                                                                                                                                                 
                    title: "Confirmação",                                                                                                                                                                                                                      
                    icon: MessageBox.Icon.INFORMATION,                                                                                                                                                                                                         
                    actions: [MessageBox.Action.YES, MessageBox.Action.NO],                                                                                                                                                                                    
                    emphasizedAction: MessageBox.Action.YES,                                                                                                                                                                                                   
                    onClose: function (oAction) {                                                                                                                                                                                                              
                        if (oAction == "YES") {                                                                                                                                                                                                                
                            this._selectedApplication = this.getOwnerComponent().getModel().getData(ApplicationEvent)                                                                                                                                          
                                                                                                                                                                                                                                                               
                            this.getOwnerComponent().getModel("ApplicationsProperty").setData({})                                                                                                                                                              
                            this.getOwnerComponent().getModel("BankData").oData.items = []                                                                                                                                                                     
                            this.getOwnerComponent().getModel("Fixation").oData = models.createLineFixation()                                                                                                                                                  
                                                                                                                                                                                                                                                               
                            this.getOwnerComponent().getModel("Application").setData(this._selectedApplication)                                                                                                                                                
                                                                                                                                                                                                                                                               
                            this._getApplicationData().then(() => {                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                            }).catch(() => {                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                            })                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                            this.refreshModel("BankData")                                                                                                                                                                                                      
                            this.refreshModel("ApplicationsProperty")                                                                                                                                                                                          
                            this.refreshModel("Fixation")                                                                                                                                                                                                      
                            this.refreshModel("Application")                                                                                                                                                                                                   
                            this._selectedApplicationId = this.byId("ApplicationsList").getSelectedItem().sId                                                                                                                                                  
                        } else {                                                                                                                                                                                                                               
                            this.byId("ApplicationsList").setSelectedItemById(this._selectedApplicationId, true)                                                                                                                                               
                        }                                                                                                                                                                                                                                      
                    }.bind(this)                                                                                                                                                                                                                               
                })                                                                                                                                                                                                                                             
            } else {                                                                                                                                                                                                                                           
                this._selectedApplication = this.getOwnerComponent().getModel().getData(oEvent.oSource._aSelectedPaths[0])                                                                                                                                     
                this.getOwnerComponent().getModel("Application").setData(this._selectedApplication)                                                                                                                                                            
                this._selectedApplicationId = this.byId("ApplicationsList").getSelectedItem().sId                                                                                                                                                              
                this._getApplicationData().then(() => {                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                }).catch(() => {                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                })                                                                                                                                                                                                                                             
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
        _getApplicationData: function () {                                                                                                                                                                                                                     
            return new Promise((resolve, reject) => {                                                                                                                                                                                                          
                if (this._selectedApplication) {                                                                                                                                                                                                               
                    this.getModel().read("/ZADOC_GRAINS_BALANCES_TO_SALES", {                                                                                                                                                                                  
                        filters: [                                                                                                                                                                                                                             
                            new Filter("ContractNum", FilterOperator.EQ, this._selectedApplication.ContractNum),                                                                                                                                               
                            new Filter("Plant", FilterOperator.EQ, this._selectedApplication.Plant),                                                                                                                                                           
                            new Filter("AppQuantity", FilterOperator.GT, 0),                                                                                                                                                                                   
                        ],                                                                                                                                                                                                                                     
                        success: function (oData) {                                                                                                                                                                                                            
                            try {                                                                                                                                                                                                                              
                                this.getOwnerComponent().getModel("ApplicationsProperty").setData(oData)                                                                                                                                                       
                                this.refreshModel("ApplicationsProperty")                                                                                                                                                                                      
                                resolve()                                                                                                                                                                                                                      
                            } catch {                                                                                                                                                                                                                          
                                reject("Falha ao obter documentos de aplicação do centro")                                                                                                                                                                     
                            }                                                                                                                                                                                                                                  
                        }.bind(this),                                                                                                                                                                                                                          
                        error: function () {                                                                                                                                                                                                                   
                            reject("Falha ao obter documentos de aplicação do centro")                                                                                                                                                                         
                        }                                                                                                                                                                                                                                      
                    })                                                                                                                                                                                                                                         
                } else { reject("Selecione uma entrada válida para realizar a fixação") }                                                                                                                                                                      
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        _refreshViewData: function () {                                                                                                                                                                                                                        
            this.getOwnerComponent().getModel("ApplicationsProperty").setData({})                                                                                                                                                                              
            this.getOwnerComponent().getModel("Fixation").oData = models.createLineFixation()                                                                                                                                                                  
            this.getOwnerComponent().getModel("Application").setData({})                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
            this.refreshModel("ApplicationsProperty")                                                                                                                                                                                                          
            this.refreshModel("Fixation")                                                                                                                                                                                                                      
            this.refreshModel("Application")                                                                                                                                                                                                                   
        },                                                                                                                                                                                                                                                     
        onFixation: function () {                                                                                                                                                                                                                              
            this._PaymentDateValidate().then(() => {                                                                                                                                                                                                           
                this._getDolarQuotation().then(() => {                                                                                                                                                                                                         
                    this._getCommodityData().then(() => {                                                                                                                                                                                                      
                        this._getApplicationData().then(() => {                                                                                                                                                                                                
                            this._getFuturePrice().then(() => {                                                                                                                                                                                                
                                this._fixationPopupPrepare()                                                                                                                                                                                                   
                            }).catch((error) => {                                                                                                                                                                                                              
                                MessageBox.show(error, {                                                                                                                                                                                                       
                                    icon: MessageBox.Icon.INFORMATION,                                                                                                                                                                                         
                                    title: "Aviso"                                                                                                                                                                                                             
                                })                                                                                                                                                                                                                             
                            })                                                                                                                                                                                                                                 
                        }).catch((error) => {                                                                                                                                                                                                                  
                            MessageBox.show(error, {                                                                                                                                                                                                           
                                icon: MessageBox.Icon.INFORMATION,                                                                                                                                                                                             
                                title: "Aviso"                                                                                                                                                                                                                 
                            })                                                                                                                                                                                                                                 
                        })                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                    }).catch((error) => {                                                                                                                                                                                                                      
                        MessageBox.show(error, {                                                                                                                                                                                                               
                            icon: MessageBox.Icon.INFORMATION,                                                                                                                                                                                                 
                            title: "Aviso"                                                                                                                                                                                                                     
                        })                                                                                                                                                                                                                                     
                    })                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                }).catch((error) => {                                                                                                                                                                                                                          
                    MessageBox.show(error, {                                                                                                                                                                                                                   
                        icon: MessageBox.Icon.INFORMATION,                                                                                                                                                                                                     
                        title: "Aviso"                                                                                                                                                                                                                         
                    })                                                                                                                                                                                                                                         
                })                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
            }).catch((error) => {                                                                                                                                                                                                                              
                MessageBox.show(error, {                                                                                                                                                                                                                       
                    icon: MessageBox.Icon.INFORMATION,                                                                                                                                                                                                         
                    title: "Aviso"                                                                                                                                                                                                                             
                })                                                                                                                                                                                                                                             
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        _PaymentDateValidate: function () {                                                                                                                                                                                                                    
            return new Promise((resolve, reject) => {                                                                                                                                                                                                          
                this._PaymentDate = this.getOwnerComponent().getModel("Fixation").getData().PaymentDate                                                                                                                                                        
                this._NewPaymentDate = this._PaymentDate.split('.')                                                                                                                                                                                            
                this._NewPaymentDate = new Date(this._NewPaymentDate[2], this._NewPaymentDate[1] - 1, this._NewPaymentDate[0], 23, 59, 59)                                                                                                                     
                if ((this._NewPaymentDate instanceof Date && !isNaN(this._NewPaymentDate)) && this._NewPaymentDate >= new Date()) {                                                                                                                            
                    let oData = {                                                                                                                                                                                                                              
                        Action: "DATEVALID",                                                                                                                                                                                                                   
                        Json: JSON.stringify([{ PaymentDate: this._PaymentDate.replaceAll(".", "") }]),                                                                                                                                                        
                        StructureName: "ZADOS_GRAINS_PAYMENT_DATE"                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                    this.getModel().create("/JsonCommunicationSet", oData, {                                                                                                                                                                                   
                        success: function (oData) {                                                                                                                                                                                                            
                            resolve()                                                                                                                                                                                                                          
                        }.bind(this),                                                                                                                                                                                                                          
                        error: function (oError) {                                                                                                                                                                                                             
                            reject("Selecione uma data válida")                                                                                                                                                                                                
                        }                                                                                                                                                                                                                                      
                    })                                                                                                                                                                                                                                         
                } else {                                                                                                                                                                                                                                       
                    reject("Selecione uma data válida")                                                                                                                                                                                                        
                }                                                                                                                                                                                                                                              
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        _getDolarQuotation: function () {                                                                                                                                                                                                                      
            return new Promise((resolve, reject) => {                                                                                                                                                                                                          
                this.getModel().read("/ZADOC_GRAINS_DOLAR_QUOTATION", {                                                                                                                                                                                        
                    success: function (oData) {                                                                                                                                                                                                                
                        try {                                                                                                                                                                                                                                  
                            this.getOwnerComponent().getModel("ConversionsModel").oData.DolarQuotation = oData.results[0].Ukurs                                                                                                                                
                            this.refreshModel("ConversionsModel")                                                                                                                                                                                              
                            resolve()                                                                                                                                                                                                                          
                        } catch {                                                                                                                                                                                                                              
                            reject("Falha ao obter cotação do dólar")                                                                                                                                                                                          
                        }                                                                                                                                                                                                                                      
                    }.bind(this),                                                                                                                                                                                                                              
                    error: function (oError) {                                                                                                                                                                                                                 
                        reject("Falha ao obter cotação do dólar")                                                                                                                                                                                              
                    }                                                                                                                                                                                                                                          
                })                                                                                                                                                                                                                                             
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        _getCommodityData: function () {                                                                                                                                                                                                                       
            return new Promise((resolve, reject) => {                                                                                                                                                                                                          
                this.getModel().read("/ZADOC_GRAINS_COMMODITY_DATA", {                                                                                                                                                                                         
                    filters: [                                                                                                                                                                                                                                 
                        new Filter("CompanyCode", FilterOperator.EQ, this.getOwnerComponent().getModel("ContractDetailsModel").getData().CompanyCode),                                                                                                         
                        new Filter("AppCode", FilterOperator.EQ, "ACMCONTROL"),                                                                                                                                                                                
                        new Filter("Commodity", FilterOperator.EQ, this.getOwnerComponent().getModel("ContractDetailsModel").getData().MaterialNum)                                                                                                            
                    ],                                                                                                                                                                                                                                         
                    success: function (oData) {                                                                                                                                                                                                                
                        try {                                                                                                                                                                                                                                  
                            this.getOwnerComponent().getModel("ConversionsModel").oData.CommodityFactor = oData.results[0].ConversionFactor                                                                                                                    
                            this.getOwnerComponent().getModel("ConversionsModel").oData.RoyaltiesBlockPerc = oData.results[0].RoyaltiesBlockPerc                                                                                                               
                            resolve()                                                                                                                                                                                                                          
                        } catch {                                                                                                                                                                                                                              
                            reject("Falha ao obter dados da commodity")                                                                                                                                                                                        
                        }                                                                                                                                                                                                                                      
                    }.bind(this),                                                                                                                                                                                                                              
                    error: function (oError) {                                                                                                                                                                                                                 
                        reject("Falha ao obter dados da commodity")                                                                                                                                                                                            
                    }                                                                                                                                                                                                                                          
                })                                                                                                                                                                                                                                             
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        _getFuturePrice: function () {                                                                                                                                                                                                                         
            this._NewPaymentDate.setDate(this._NewPaymentDate.getDate() - 1)                                                                                                                                                                                   
            let Day = new Date()                                                                                                                                                                                                                               
            return new Promise((resolve, reject) => {                                                                                                                                                                                                          
                this.getModel().read("/ZADOC_GRAINS_FUTURE_PRICE", {                                                                                                                                                                                           
                    filters: [                                                                                                                                                                                                                                 
                        new Filter("Commodity", FilterOperator.EQ, this.getOwnerComponent().getModel("ContractDetailsModel").getData().MaterialNum),                                                                                                           
                        new Filter("Plant", FilterOperator.EQ, this._selectedApplication.Plant),                                                                                                                                                               
                        new Filter("CompanyCode", FilterOperator.EQ, this.getOwnerComponent().getModel("ContractDetailsModel").getData().CompanyCode),                                                                                                         
                        new Filter("DueDate", FilterOperator.GE, this._NewPaymentDate),                                                                                                                                                                        
                        new Filter("PriceDate", FilterOperator.EQ, Day),                                                                                                                                                                                       
                    ],                                                                                                                                                                                                                                         
                    sorters: [                                                                                                                                                                                                                                 
                        new Sorter("DueDate", false)                                                                                                                                                                                                           
                    ],                                                                                                                                                                                                                                         
                    success: function (oData) {                                                                                                                                                                                                                
                        try {                                                                                                                                                                                                                                  
                            this.getOwnerComponent().getModel("Fixation").oData.FuturePrice = oData.results[0].Price                                                                                                                                           
                            this.getOwnerComponent().getModel("Fixation").oData.DueCode = oData.results[0].DueCode                                                                                                                                             
                            this.getOwnerComponent().getModel("Fixation").oData.AvailableQuantity = this.getView().getModel("Application").getData().AvailableQuantity                                                                                         
                            this.refreshModel("Fixation")                                                                                                                                                                                                      
                            this._NewPaymentDate.setDate(this._NewPaymentDate.getDate() + 1)                                                                                                                                                                   
                            resolve()                                                                                                                                                                                                                          
                        } catch {                                                                                                                                                                                                                              
                            reject("Falha ao obter preço futuro")                                                                                                                                                                                              
                        }                                                                                                                                                                                                                                      
                    }.bind(this),                                                                                                                                                                                                                              
                    error: function (oError) {                                                                                                                                                                                                                 
                        this._NewPaymentDate.setDate(this._NewPaymentDate.getDate() + 1)                                                                                                                                                                       
                        reject("Falha ao obter preço futuro")                                                                                                                                                                                                  
                    }                                                                                                                                                                                                                                          
                })                                                                                                                                                                                                                                             
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        _fixationPopupPrepare: function () {                                                                                                                                                                                                                   
            if (this.getView().getModel("Application").getData().TotalQuantity > 0) {                                                                                                                                                                          
                if (this.getOwnerComponent().getModel("ConversionsModel").getData().DolarQuotation > 0) {                                                                                                                                                      
                    if (this.getOwnerComponent().getModel("Fixation").oData.FuturePrice > 0) {                                                                                                                                                                 
                        this._showFixationPopup()                                                                                                                                                                                                              
                    } else {                                                                                                                                                                                                                                   
                        MessageBox.show("Não foi possível estabelecer o preço futuro", {                                                                                                                                                                       
                            icon: MessageBox.Icon.INFORMATION,                                                                                                                                                                                                 
                            title: "Aviso"                                                                                                                                                                                                                     
                        })                                                                                                                                                                                                                                     
                    }                                                                                                                                                                                                                                          
                } else {                                                                                                                                                                                                                                       
                    MessageBox.show("Não foi possível estabelecer a cotação do dólar", {                                                                                                                                                                       
                        icon: MessageBox.Icon.INFORMATION,                                                                                                                                                                                                     
                        title: "Aviso"                                                                                                                                                                                                                         
                    })                                                                                                                                                                                                                                         
                }                                                                                                                                                                                                                                              
            } else {                                                                                                                                                                                                                                           
                MessageBox.show("Selecione uma propriedade com saldo para realizar a fixação", {                                                                                                                                                               
                    icon: MessageBox.Icon.INFORMATION,                                                                                                                                                                                                         
                    title: "Aviso"                                                                                                                                                                                                                             
                })                                                                                                                                                                                                                                             
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
        _showFixationPopup: function () {                                                                                                                                                                                                                      
            this.getOwnerComponent().getModel("Fixation").getData().AvailableQuantity =                                                                                                                                                                        
                this.getView().getModel("Application").getData().TotalQuantity                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            this.refreshModel("Fixation")                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
            if (!this._SalesFixationFragment) {                                                                                                                                                                                                                
                this._SalesFixationFragment = Fragment.load({                                                                                                                                                                                                  
                    id: this.getView().getId(),                                                                                                                                                                                                                
                    name: "grains.zadograinsacmcontrolling.view.fragments.SalesFixation",                                                                                                                                                                      
                    controller: this                                                                                                                                                                                                                           
                }).then(function (oValueHelpDialog) {                                                                                                                                                                                                          
                    this.getView().addDependent(oValueHelpDialog);                                                                                                                                                                                             
                    return oValueHelpDialog;                                                                                                                                                                                                                   
                }.bind(this));                                                                                                                                                                                                                                 
            }                                                                                                                                                                                                                                                  
            this._SalesFixationFragment.then(function (oValueHelpDialog) {                                                                                                                                                                                     
                oValueHelpDialog.open();                                                                                                                                                                                                                       
            });                                                                                                                                                                                                                                                
        },                                                                                                                                                                                                                                                     
        onSaveFixation: function (oEvent) {                                                                                                                                                                                                                    
            if (this._fixationPopUpValidate().isValid) {                                                                                                                                                                                                       
                this.byId("MessageStrip").setVisible(false)                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                let Fixation = this.getOwnerComponent().getModel("Fixation").getData()                                                                                                                                                                         
                this._updateApplicationsTable(Fixation.Quantity)                                                                                                                                                                                               
                this._CommodityConversionFactor = this.getOwnerComponent().getModel("ConversionsModel").getData().CommodityFactor                                                                                                                              
                this._DolarQuotation = this.getOwnerComponent().getModel("ConversionsModel").getData().DolarQuotation                                                                                                                                          
                Fixation.Amount = ((Fixation.BagPrice[0] / 60) * Fixation.Quantity)                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                Fixation.BasisPrice = (((this._toNumber(Fixation.BagPrice[0]) / this._DolarQuotation) / this._CommodityConversionFactor) -                                                                                                                     
                    this._toNumber(Fixation.FuturePrice))                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                this.getOwnerComponent().getModel("Fixation").setData(Fixation)                                                                                                                                                                                
                this.getOwnerComponent().getModel("Fixation").refresh(true)                                                                                                                                                                                    
                this.getOwnerComponent().getModel("ConversionsModel").refresh(true)                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                this.byId("FixationDialog").close()                                                                                                                                                                                                            
            } else {                                                                                                                                                                                                                                           
                this.byId("MessageStrip").setType(this._fixationPopUpValidate().State)                                                                                                                                                                         
                this.byId("MessageStrip").setText(this._fixationPopUpValidate().Message)                                                                                                                                                                       
                this.byId("MessageStrip").setVisible(true)                                                                                                                                                                                                     
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
        _updateApplicationsTable: function (RemainingQuantity) {                                                                                                                                                                                               
            this.getOwnerComponent().getModel("ApplicationsProperty").getData().results.forEach((element) => {                                                                                                                                                 
                element.FinalQuantity = element.AvailableQuantity                                                                                                                                                                                              
            })                                                                                                                                                                                                                                                 
            this.getOwnerComponent().getModel("ApplicationsProperty").getData().results.forEach((element) => {                                                                                                                                                 
                element.FinalQuantity = element.FinalQuantity - RemainingQuantity                                                                                                                                                                              
                RemainingQuantity = element.FinalQuantity < 0 ? element.FinalQuantity * -1 : "0"                                                                                                                                                               
                element.FinalQuantity = element.FinalQuantity > 0 ? element.FinalQuantity : "0"                                                                                                                                                                
            })                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            this.refreshModel("ApplicationsProperty")                                                                                                                                                                                                          
            this.refreshModel("Fixation")                                                                                                                                                                                                                      
        },                                                                                                                                                                                                                                                     
        onCloseFixation: function (oEvent) {                                                                                                                                                                                                                   
            this._getApplicationData()                                                                                                                                                                                                                         
            this.getOwnerComponent().getModel("Fixation").setData(models.createLineFixation())                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            this.refreshModel("Fixation")                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
            this.byId("MessageStrip").setVisible(false)                                                                                                                                                                                                        
            this.byId("FixationDialog").close()                                                                                                                                                                                                                
        },                                                                                                                                                                                                                                                     
        _fixationPopUpValidate: function () {                                                                                                                                                                                                                  
            let Fixation = this.getOwnerComponent().getModel("Fixation").getData()                                                                                                                                                                             
                                                                                                                                                                                                                                                               
            let isValid = true                                                                                                                                                                                                                                 
            let State = ""                                                                                                                                                                                                                                     
            let Message = ""                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            if (Fixation.BagPrice[0] < 1 || Fixation.Quantity < 1) {                                                                                                                                                                                           
                isValid = false                                                                                                                                                                                                                                
                State = "Error"                                                                                                                                                                                                                                
                Message = "Quantidade ou preço fornecido é inválido"                                                                                                                                                                                           
            }                                                                                                                                                                                                                                                  
            else if (parseFloat(Fixation.Quantity) > parseFloat(Fixation.AvailableQuantity)) {                                                                                                                                                                 
                isValid = false                                                                                                                                                                                                                                
                State = "Error"                                                                                                                                                                                                                                
                Message = "Quantidade fornecida é superior ao saldo disponível para propriedade"                                                                                                                                                               
            }                                                                                                                                                                                                                                                  
            return {                                                                                                                                                                                                                                           
                isValid: isValid,                                                                                                                                                                                                                              
                State: State,                                                                                                                                                                                                                                  
                Message: Message                                                                                                                                                                                                                               
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
        _toNumber: function (Price) {                                                                                                                                                                                                                          
            Price = Price.toString()                                                                                                                                                                                                                           
            return parseFloat(Price.replace(',', '.'))                                                                                                                                                                                                         
        },                                                                                                                                                                                                                                                     
        onCreateFixation: function () {                                                                                                                                                                                                                        
            this._fixationValidate().then(() => {                                                                                                                                                                                                              
                let oData = this._getFixationData()                                                                                                                                                                                                            
                this._Send(oData)                                                                                                                                                                                                                              
            }).catch((error) => {                                                                                                                                                                                                                              
                MessageToast.show(error)                                                                                                                                                                                                                       
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        _fixationValidate() {                                                                                                                                                                                                                                  
            return new Promise((resolve, reject) => {                                                                                                                                                                                                          
                try {                                                                                                                                                                                                                                          
                    this._FixationData = this.getOwnerComponent().getModel("Fixation").getData()                                                                                                                                                               
                    this._ApplicationsProperty = this.getOwnerComponent().getModel("ApplicationsProperty").getData()                                                                                                                                           
                    this._ContractData = this.getView().getModel("ContractDetailsModel").getData()                                                                                                                                                             
                                                                                                                                                                                                                                                               
                    this._DolarQuotation = this.getView().getModel("ConversionsModel").getData().DolarQuotation                                                                                                                                                
                                                                                                                                                                                                                                                               
                    if (this._FixationData.Quantity < 1 || !this._FixationData.Quantity) {                                                                                                                                                                     
                        throw 'Quantidade é inválida'                                                                                                                                                                                                          
                    }                                                                                                                                                                                                                                          
                    if (this._FixationData.Amount < 1 || !this._FixationData.Amount) {                                                                                                                                                                         
                        throw 'Montante é inválida'                                                                                                                                                                                                            
                    }                                                                                                                                                                                                                                          
                    if (this._FixationData.Quantity < 1 || !this._FixationData.Quantity) {                                                                                                                                                                     
                        throw 'Quantidade é inválida'                                                                                                                                                                                                          
                    }                                                                                                                                                                                                                                          
                    if (this._DolarQuotation < 1 || !this._DolarQuotation) {                                                                                                                                                                                   
                        throw 'Cotação do dólar é inválido'                                                                                                                                                                                                    
                    }                                                                                                                                                                                                                                          
                    if (this._ApplicationsProperty.results.length < 1 || !this._ApplicationsProperty.results.length) {                                                                                                                                         
                        throw 'Saldo das aplicações é inválido'                                                                                                                                                                                                
                    }                                                                                                                                                                                                                                          
                    resolve()                                                                                                                                                                                                                                  
                } catch (error) {                                                                                                                                                                                                                              
                    reject(error)                                                                                                                                                                                                                              
                }                                                                                                                                                                                                                                              
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        _getFixationData: function () {                                                                                                                                                                                                                        
            var Applications = []                                                                                                                                                                                                                              
            debugger                                                                                                                                                                                                                                           
            try {                                                                                                                                                                                                                                              
                this._ApplicationsProperty.results.forEach((element) => {                                                                                                                                                                                      
                    Applications.push({                                                                                                                                                                                                                        
                        ApplicationDoc: element.ApplicationDoc,                                                                                                                                                                                                
                        EdcNum: element.Edc,                                                                                                                                                                                                                   
                        ApplicationQuantity: element.AvailableQuantity - element.FinalQuantity,                                                                                                                                                                
                        Measure: 'KG'                                                                                                                                                                                                                          
                    })                                                                                                                                                                                                                                         
                })                                                                                                                                                                                                                                             
                this._FixationObject = JSON.stringify([                                                                                                                                                                                                        
                    {                                                                                                                                                                                                                                          
                        Plant: this._selectedApplication.Plant,                                                                                                                                                                                                
                        Contract: this._ContractData.ContractNum,                                                                                                                                                                                              
                        Identification: this._ContractData.IdentificationFix,                                                                                                                                                                                  
                        Quantity: this._FixationData.Quantity,                                                                                                                                                                                                 
                        Unit: 'KG',                                                                                                                                                                                                                            
                        Material: this._ContractData.Material,                                                                                                                                                                                                 
                        MaterialNum: this._ContractData.MaterialNum,                                                                                                                                                                                           
                        BagPrice: this._FixationData.BagPrice[0],                                                                                                                                                                                              
                        Currency: this._FixationData.Currency,                                                                                                                                                                                                 
                        BasisPrice: parseFloat(this._FixationData.BasisPrice.toFixed(4)),                                                                                                                                                                      
                        FuturePrice: this._FixationData.FuturePrice,                                                                                                                                                                                           
                        Amount: this._FixationData.Amount,                                                                                                                                                                                                     
                        KeydateCode: this._FixationData.DueCode,                                                                                                                                                                                               
                        PaymentDate: this._FixationData.PaymentDate.replaceAll(".", ''),                                                                                                                                                                       
                        DolarQuotation: this._DolarQuotation,                                                                                                                                                                                                  
                        ApplicationData: Applications,                                                                                                                                                                                                         
                    }                                                                                                                                                                                                                                          
                ])                                                                                                                                                                                                                                             
                return {                                                                                                                                                                                                                                       
                    Action: "SALESFIX",                                                                                                                                                                                                                        
                    Json: this._FixationObject,                                                                                                                                                                                                                
                    StructureName: "ZADOS_GRAINS_CREATE_FIXATION"                                                                                                                                                                                              
                }                                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
            catch {                                                                                                                                                                                                                                            
                MessageBox.show("Dados da fixação incompletos", {                                                                                                                                                                                              
                    icon: MessageBox.Icon.INFORMATION,                                                                                                                                                                                                         
                    title: "Aviso"                                                                                                                                                                                                                             
                })                                                                                                                                                                                                                                             
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
        _Send: function (oData) {                                                                                                                                                                                                                              
            sap.ui.core.BusyIndicator.show();                                                                                                                                                                                                                  
            this.getModel().create("/JsonCommunicationSet", oData, {                                                                                                                                                                                           
                success: function () {                                                                                                                                                                                                                         
                    let error = this.fillMessagesModel()                                                                                                                                                                                                       
                    this.MessageBarChangeVisible(true)                                                                                                                                                                                                         
                    this._refreshViewData()                                                                                                                                                                                                                    
                    sap.ui.core.BusyIndicator.hide();                                                                                                                                                                                                          
                    if (error) {                                                                                                                                                                                                                               
                        MessageToast.show("Ocorreram erros no processo")                                                                                                                                                                                       
                    } else {                                                                                                                                                                                                                                   
                        MessageToast.show("Processo executado com sucesso")                                                                                                                                                                                    
                        setTimeout(function () {                                                                                                                                                                                                               
                            this.getRouter().navTo("RouteContractDetails", {                                                                                                                                                                                   
                                Contract: this.getOwnerComponent().getModel("ContractDetailsModel").getData().ContractNum                                                                                                                                      
                            })                                                                                                                                                                                                                                 
                        }.bind(this), 1000)                                                                                                                                                                                                                    
                    }                                                                                                                                                                                                                                          
                }.bind(this),                                                                                                                                                                                                                                  
                error: function () {                                                                                                                                                                                                                           
                    let error = this.fillMessagesModel()                                                                                                                                                                                                       
                    this.MessageBarChangeVisible(true)                                                                                                                                                                                                         
                    this._refreshViewData()                                                                                                                                                                                                                    
                    sap.ui.core.BusyIndicator.hide();                                                                                                                                                                                                          
                    MessageToast.show("Houve um erro interno")                                                                                                                                                                                                 
                }.bind(this)                                                                                                                                                                                                                                   
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        onLiquidation: function (oEvent) {                                                                                                                                                                                                                     
            try {                                                                                                                                                                                                                                              
                let sPath = this.getView().getObjectBinding().getPath()                                                                                                                                                                                        
                let oFixationData = this.getView().getModel().getData(sPath)                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                if (oFixationData.FixationStatus !== 'T')                                                                                                                                                                                                      
                    throw 'Não é possível realizar a liquidação, fixação não aprovada'                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                sap.ui.core.BusyIndicator.show();                                                                                                                                                                                                              
                this._sendLiquidation(oFixationData).then((oSuccess) => {                                                                                                                                                                                      
                    let error = this.fillMessagesModel()                                                                                                                                                                                                       
                    this.MessageBarChangeVisible(true)                                                                                                                                                                                                         
                    sap.ui.core.BusyIndicator.hide();                                                                                                                                                                                                          
                    if (error) {                                                                                                                                                                                                                               
                        MessageToast.show("Aconteceram erros no processo, visualizar mensagens")                                                                                                                                                               
                    } else {                                                                                                                                                                                                                                   
                        MessageToast.show("Processo executado com sucesso!")                                                                                                                                                                                   
                    }                                                                                                                                                                                                                                          
                }).catch((oError) => {                                                                                                                                                                                                                         
                    let error = this.fillMessagesModel()                                                                                                                                                                                                       
                    this.MessageBarChangeVisible(true)                                                                                                                                                                                                         
                    sap.ui.core.BusyIndicator.hide();                                                                                                                                                                                                          
                    MessageToast.show("Houve um erro interno")                                                                                                                                                                                                 
                })                                                                                                                                                                                                                                             
            }                                                                                                                                                                                                                                                  
            catch (error) {                                                                                                                                                                                                                                    
                MessageToast.show("Falha ao efetuar a liquidação")                                                                                                                                                                                             
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
        _sendLiquidation: function (FixationData) {                                                                                                                                                                                                            
            return new Promise((resolve, reject) => {                                                                                                                                                                                                          
                try {                                                                                                                                                                                                                                          
                    var oData = {                                                                                                                                                                                                                              
                        Action: "LIQUIDATE",                                                                                                                                                                                                                   
                        Json: JSON.stringify([{                                                                                                                                                                                                                
                            Contract: FixationData.ContractNum,                                                                                                                                                                                                
                            Identification: FixationData.FixationId                                                                                                                                                                                            
                        }]),                                                                                                                                                                                                                                   
                        StructureName: "ZADOS_GRAINS_CREATE_FIXATION"                                                                                                                                                                                          
                    }                                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
                catch {                                                                                                                                                                                                                                        
                    reject()                                                                                                                                                                                                                                   
                }                                                                                                                                                                                                                                              
                this.getModel().create("/JsonCommunicationSet", oData, {                                                                                                                                                                                       
                    success: function (oData) {                                                                                                                                                                                                                
                        resolve()                                                                                                                                                                                                                              
                    }.bind(this),                                                                                                                                                                                                                              
                    error: function (oError) {                                                                                                                                                                                                                 
                        reject()                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                })                                                                                                                                                                                                                                             
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        onPrintForm: function (oEvent) {                                                                                                                                                                                                                       
            let oData = this.getView().getModel().getData(this.getStorage("Fixation").sPath)                                                                                                                                                                   
            this._PreviewSmartform(this.getView(), 'ZADOSF_GRAINS_BOL_FIX_SELL', {                                                                                                                                                                             
                contract_num: oData.ContractNum,                                                                                                                                                                                                               
                plant_nr: oData.Plant,                                                                                                                                                                                                                         
                idnum: oData.FixationId                                                                                                                                                                                                                        
            })                                                                                                                                                                                                                                                 
        }                                                                                                                                                                                                                                                      
    });                                                                                                                                                                                                                                                        
});                                                                                                                                                                                                                                                            