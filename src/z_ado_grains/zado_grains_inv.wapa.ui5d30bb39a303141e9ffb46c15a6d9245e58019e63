sap.ui.define([                                                                                                                                                                                                                                                
    "sap/ui/core/mvc/Controller",                                                                                                                                                                                                                              
    "sap/ui/core/routing/History",                                                                                                                                                                                                                             
    "sap/fe/navigation/ParamHandlingMode"                                                                                                                                                                                                                      
], function (Controller,                                                                                                                                                                                                                                       
    History,                                                                                                                                                                                                                                                   
    ParamHandlingMode) {                                                                                                                                                                                                                                       
    "use strict";                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    return Controller.extend("grains.zadograinsacmcontrollingclearingacc.controller.BaseController", {                                                                                                                                                         
        /**                                                                                                                                                                                                                                                    
         * Convenience method for accessing the router in every controller of the application.                                                                                                                                                                 
         * @public                                                                                                                                                                                                                                             
         * @returns {sap.ui.core.routing.Router} the router for this component                                                                                                                                                                                 
         */                                                                                                                                                                                                                                                    
        getRouter: function () {                                                                                                                                                                                                                               
            return this.getOwnerComponent().getRouter();                                                                                                                                                                                                       
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Convenience method for getting the view model by name in every controller of the application.                                                                                                                                                       
         * @public                                                                                                                                                                                                                                             
         * @param {string} sName the model name                                                                                                                                                                                                                
         * @returns {sap.ui.model.Model} the model instance                                                                                                                                                                                                    
         */                                                                                                                                                                                                                                                    
        getModel: function (sName) {                                                                                                                                                                                                                           
            return this.getView().getModel(sName);                                                                                                                                                                                                             
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Convenience method for setting the view model in every controller of the application.                                                                                                                                                               
         * @public                                                                                                                                                                                                                                             
         * @param {sap.ui.model.Model} oModel the model instance                                                                                                                                                                                               
         * @param {string} sName the model name                                                                                                                                                                                                                
         * @returns {sap.ui.mvc.View} the view instance                                                                                                                                                                                                        
         */                                                                                                                                                                                                                                                    
        setModel: function (oModel, sName) {                                                                                                                                                                                                                   
            return this.getView().setModel(oModel, sName);                                                                                                                                                                                                     
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Convenience method for getting the resource bundle.                                                                                                                                                                                                 
         * @public                                                                                                                                                                                                                                             
         * @returns {sap.ui.model.resource.ResourceModel} the resourceModel of the component                                                                                                                                                                   
         */                                                                                                                                                                                                                                                    
        getResourceBundle: function () {                                                                                                                                                                                                                       
            return this.getOwnerComponent().getModel("i18n").getResourceBundle();                                                                                                                                                                              
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Event handler for navigating back.                                                                                                                                                                                                                  
         * It there is a history entry we go one step back in the browser history                                                                                                                                                                              
         * If not, it will replace the current entry of the browser history with the list route.                                                                                                                                                               
         * @public                                                                                                                                                                                                                                             
         */                                                                                                                                                                                                                                                    
        onNavBack: function () {                                                                                                                                                                                                                               
            var sPreviousHash = History.getInstance().getPreviousHash();                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
            if (sPreviousHash !== undefined) {                                                                                                                                                                                                                 
                // eslint-disable-next-line sap-no-history-manipulation                                                                                                                                                                                        
                history.go(-1);                                                                                                                                                                                                                                
            } else {                                                                                                                                                                                                                                           
                this.getRouter().navTo("list", {}, true);                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        onMessagesButtonPress: function (oEvent) {                                                                                                                                                                                                             
            var that = this;                                                                                                                                                                                                                                   
            try {                                                                                                                                                                                                                                              
                var oMessagesButton = oEvent.getSource();                                                                                                                                                                                                      
            } catch (error) {                                                                                                                                                                                                                                  
                var oMessagesButton = oEvent;                                                                                                                                                                                                                  
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            if (!this._messagePopover) {                                                                                                                                                                                                                       
                this._messagePopover = new sap.m.MessagePopover({                                                                                                                                                                                              
                    headerButton: new sap.m.Button({                                                                                                                                                                                                           
                        type: sap.m.ButtonType.Reject,                                                                                                                                                                                                         
                        icon: "sap-icon://delete",                                                                                                                                                                                                             
                        press: function () {                                                                                                                                                                                                                   
                            this._messagePopover.close();                                                                                                                                                                                                      
                            sap.ui.getCore().getMessageManager().removeAllMessages()                                                                                                                                                                           
                        }.bind(this),                                                                                                                                                                                                                          
                    }),                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                    items: {                                                                                                                                                                                                                                   
                        path: "message>/",                                                                                                                                                                                                                     
                        template: new sap.m.MessageItem({                                                                                                                                                                                                      
                            description: "{message>description}",                                                                                                                                                                                              
                            type: "{message>type}",                                                                                                                                                                                                            
                            title: "{message>message}",                                                                                                                                                                                                        
                            subtitle: "{message>additionalText}",                                                                                                                                                                                              
                            description: "{message>description}",                                                                                                                                                                                              
                        }),                                                                                                                                                                                                                                    
                    },                                                                                                                                                                                                                                         
                });                                                                                                                                                                                                                                            
                oMessagesButton.addDependent(this._messagePopover);                                                                                                                                                                                            
            }                                                                                                                                                                                                                                                  
            this._messagePopover.toggle(oMessagesButton);                                                                                                                                                                                                      
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        JsonCommunication: function (payload) {                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            return new Promise(function (resolve, reject) {                                                                                                                                                                                                    
                var oViewModel = this.getModel("detailView");                                                                                                                                                                                                  
                var oModel = this.getView().getModel();                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                oModel.create("/JsonCommunicationSet", payload, {                                                                                                                                                                                              
                    success: function (oData, oResponse) {                                                                                                                                                                                                     
                        setTimeout(                                                                                                                                                                                                                            
                            function () {                                                                                                                                                                                                                      
                                var oButton = this.byId("MessageIndicator");                                                                                                                                                                                   
                                this.onMessagesButtonPress(oButton);                                                                                                                                                                                           
                            }.bind(this),                                                                                                                                                                                                                      
                            100                                                                                                                                                                                                                                
                        );                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        oViewModel.setProperty("/busy", false);                                                                                                                                                                                                
                        resolve()                                                                                                                                                                                                                              
                    }.bind(this),                                                                                                                                                                                                                              
                    error: function (oError) {                                                                                                                                                                                                                 
                        setTimeout(                                                                                                                                                                                                                            
                            function () {                                                                                                                                                                                                                      
                                var oButton = this.byId("MessageIndicator");                                                                                                                                                                                   
                                this.onMessagesButtonPress(oButton);                                                                                                                                                                                           
                            }.bind(this),                                                                                                                                                                                                                      
                            100                                                                                                                                                                                                                                
                        );                                                                                                                                                                                                                                     
                        oViewModel.setProperty("/busy", false);                                                                                                                                                                                                
                        reject();                                                                                                                                                                                                                              
                    }.bind(this),                                                                                                                                                                                                                              
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            }.bind(this));                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        _getAccountingDocumentTree: function (oObject) {                                                                                                                                                                                                       
            // var oViewModel = this.getView().getModel("detailDetailView");                                                                                                                                                                                   
            // var oObject = this.getView().getBindingContext().getObject();                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            var oModel = this.getView().getModel();                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            var aFilters = [new sap.ui.model.Filter({ path: "CompanyCode", operator: sap.ui.model.FilterOperator.EQ, value1: oObject.InvoiceCompanyCode }),                                                                                                    
            new sap.ui.model.Filter({ path: "AccountingDocument", operator: sap.ui.model.FilterOperator.EQ, value1: oObject.AccountingDocument }),                                                                                                             
            new sap.ui.model.Filter({ path: "AccountingDocumentYear", operator: sap.ui.model.FilterOperator.EQ, value1: oObject.AccountingDocumentYear }),                                                                                                     
            new sap.ui.model.Filter({ path: "AccountingItem", operator: sap.ui.model.FilterOperator.EQ, value1: oObject.AccountingItem })];                                                                                                                    
                                                                                                                                                                                                                                                               
            oModel.read('/AccountingDocumentTreeSet', {                                                                                                                                                                                                        
                filters: aFilters,                                                                                                                                                                                                                             
                success: function (oData, oResponse) {                                                                                                                                                                                                         
                    var deepData = this._transformTreeData(oData.results);                                                                                                                                                                                     
                    this._setNodesModelData(deepData);                                                                                                                                                                                                         
                }.bind(this),                                                                                                                                                                                                                                  
                error: function (oError) {                                                                                                                                                                                                                     
                }.bind(this)                                                                                                                                                                                                                                   
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        _transformTreeData: function (nodesIn) {                                                                                                                                                                                                               
            var nodes = [];                                                                                                                                                                                                                                    
            var nodeMap = {};                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            if (nodesIn) {                                                                                                                                                                                                                                     
                var nodeOut;                                                                                                                                                                                                                                   
                var parentId;                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                for (var i = 0; i < nodesIn.length; i++) {                                                                                                                                                                                                     
                    var nodeIn = nodesIn[i]                                                                                                                                                                                                                    
                    nodeOut = {                                                                                                                                                                                                                                
                        NodeId: nodeIn.NodeId,                                                                                                                                                                                                                 
                        ParentNodeId: nodeIn.ParentNodeId,                                                                                                                                                                                                     
                        HierarchyLevel: nodeIn.HierarchyLevel,                                                                                                                                                                                                 
                        DrillState: nodeIn.DrillState,                                                                                                                                                                                                         
                        AccountingDocument: nodeIn.AccountingDocument,                                                                                                                                                                                         
                        AccountingDocumentYear: nodeIn.AccountingDocumentYear,                                                                                                                                                                                 
                        AccountingItem: nodeIn.AccountingItem,                                                                                                                                                                                                 
                        Amount: nodeIn.Amount,                                                                                                                                                                                                                 
                        Currency: nodeIn.Currency,                                                                                                                                                                                                             
                        Status: nodeIn.Status,                                                                                                                                                                                                                 
                        ClearingDocumentYear: nodeIn.ClearingDocumentYear,                                                                                                                                                                                     
                        ClearingDocument: nodeIn.ClearingDocument,                                                                                                                                                                                             
                        Description: nodeIn.Description,                                                                                                                                                                                                       
                        children: []                                                                                                                                                                                                                           
                    };                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                    parentId = nodeIn.ParentNodeId;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                    if (parentId && parentId > 0) {                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                        var parent = nodeMap[nodeIn.ParentNodeId];                                                                                                                                                                                             
                        var idChildren = parent.children.length + 1;                                                                                                                                                                                           
                        nodeOut.Description = parent.Description + '.' + idChildren;                                                                                                                                                                           
                        if (parent) { parent.children.push(nodeOut) }                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    } else {                                                                                                                                                                                                                                   
                        nodes.push(nodeOut);                                                                                                                                                                                                                   
                    }                                                                                                                                                                                                                                          
                    nodeMap[nodeOut.NodeId] = nodeOut;                                                                                                                                                                                                         
                };                                                                                                                                                                                                                                             
            };                                                                                                                                                                                                                                                 
            return nodes;                                                                                                                                                                                                                                      
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        _setNodesModelData: function (nodes) {                                                                                                                                                                                                                 
            var oTreeTableModel = this.getOwnerComponent().getModel("nodeModel");                                                                                                                                                                              
            var oTreeTable = this.byId("treeTable");                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
            if (oTreeTableModel) {                                                                                                                                                                                                                             
                oTreeTableModel.setData({ nodeRoot: { children: nodes } });                                                                                                                                                                                    
                oTreeTableModel.refresh();                                                                                                                                                                                                                     
            } else {                                                                                                                                                                                                                                           
                var nodesModel = new sap.ui.model.json.JSONModel();                                                                                                                                                                                            
                nodesModel.setData({ nodeRoot: { children: nodes } });                                                                                                                                                                                         
                this.getOwnerComponent().setModel(nodesModel, "nodeModel");                                                                                                                                                                                    
            };                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            if (oTreeTable) {                                                                                                                                                                                                                                  
                oTreeTable.refreshRows();                                                                                                                                                                                                                      
                oTreeTable.expandToLevel(1);                                                                                                                                                                                                                   
            } else {                                                                                                                                                                                                                                           
                var oTreeTable = this.getOwnerComponent().byId('detailDetail--treeTable');                                                                                                                                                                     
                oTreeTable.refreshRows();                                                                                                                                                                                                                      
                oTreeTable.expandToLevel(1);                                                                                                                                                                                                                   
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onTreeTableRefresh: function () {                                                                                                                                                                                                                      
            var oDetailItemSelected = this.byId('tableInvoiceItems');                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
            if (oDetailItemSelected) {                                                                                                                                                                                                                         
                if (oDetailItemSelected.getSelectedItem()) {                                                                                                                                                                                                   
                    var oObject = oDetailItemSelected.getSelectedItem().getBindingContext().getObject();                                                                                                                                                       
                } else {                                                                                                                                                                                                                                       
                    return;                                                                                                                                                                                                                                    
                };                                                                                                                                                                                                                                             
            } else {                                                                                                                                                                                                                                           
                var oObject = this.getView().getBindingContext().getObject();                                                                                                                                                                                  
            };                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            this._getAccountingDocumentTree(oObject);                                                                                                                                                                                                          
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        callTransaction(semanticObject, action, params) {                                                                                                                                                                                                      
            var oService = sap.ushell.Container.getService("CrossApplicationNavigation");                                                                                                                                                                      
            var sHref = oService.hrefForExternal({                                                                                                                                                                                                             
                target: {                                                                                                                                                                                                                                      
                    semanticObject: semanticObject,                                                                                                                                                                                                            
                    action: action                                                                                                                                                                                                                             
                },                                                                                                                                                                                                                                             
                params: params                                                                                                                                                                                                                                 
            });                                                                                                                                                                                                                                                
            window.location.href = sHref;                                                                                                                                                                                                                      
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
});                                                                                                                                                                                                                                                            