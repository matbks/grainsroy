sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","../model/models","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ui/model/Sorter","sap/ui/core/Fragment","sap/m/MessageToast"],function(t,e,+
i,o,a,n,s,r,l,c){"use strict";return t.extend("grains.zadograinsacmcontrolling.controller.SalesContractFixation",{formatter:i,onInit:function(){this.initMessageProcessor();this.getRouter().attachRoutePatternMatched(this._onObjectMathed,this)},_onObjectMa+
thed:function(t){this._Fixation=t.getParameter("arguments").Fixation;debugger;if(!this._Fixation){this._newFixation()}else{this._getFixation(this._Fixation)}this._refreshViewData()},_newFixation:function(){this.getModel().read(this.getStorage("SelectedPa+
th").Path,{success:function(t){this.getOwnerComponent().setModel(new e(t),"ContractDetailsModel");this.byId("SalesContractFixationCreationPage").setVisible(true);this.byId("SalesContractFixationDetailPage").setVisible(false)}.bind(this),error:function(){+
c.show("Falha ao obter dados do contrato")}});this._applicationsListInitialization()},_getFixation:function(t){this.byId("SalesContractFixationCreationPage").setVisible(false);this.byId("SalesContractFixationDetailPage").setVisible(true);this.getView().b+
indElement(this.getStorage("Fixation").sPath)},_applicationsListInitialization:function(){this._oContext=new sap.ui.model.Context(this.getOwnerComponent().getModel(),this.getStorage("SelectedPath").Path);this.byId("SalesApplicationsSmartList").setBinding+
Context(this._oContext);this.byId("SalesApplicationsSmartList").getList().removeSelections()},onSelectApplication:function(t){if(this.getOwnerComponent().getModel("Fixation").getData().Quantity>0){var e=t.oSource._aSelectedPaths[0];s.show("Ao alterar o c+
entro os dados da fixação serão perdidos, deseja continuar?",{title:"Confirmação",icon:s.Icon.INFORMATION,actions:[s.Action.YES,s.Action.NO],emphasizedAction:s.Action.YES,onClose:function(t){if(t=="YES"){this._selectedApplication=this.getOwnerComponent()+
.getModel().getData(e);this.getOwnerComponent().getModel("ApplicationsProperty").setData({});this.getOwnerComponent().getModel("BankData").oData.items=[];this.getOwnerComponent().getModel("Fixation").oData=o.createLineFixation();this.getOwnerComponent().+
getModel("Application").setData(this._selectedApplication);this._getApplicationData().then(()=>{}).catch(()=>{});this.refreshModel("BankData");this.refreshModel("ApplicationsProperty");this.refreshModel("Fixation");this.refreshModel("Application");this._+
selectedApplicationId=this.byId("ApplicationsList").getSelectedItem().sId}else{this.byId("ApplicationsList").setSelectedItemById(this._selectedApplicationId,true)}}.bind(this)})}else{this._selectedApplication=this.getOwnerComponent().getModel().getData(t+
.oSource._aSelectedPaths[0]);this.getOwnerComponent().getModel("Application").setData(this._selectedApplication);this._selectedApplicationId=this.byId("ApplicationsList").getSelectedItem().sId;this._getApplicationData().then(()=>{}).catch(()=>{})}},_getA+
pplicationData:function(){return new Promise((t,e)=>{if(this._selectedApplication){this.getModel().read("/ZADOC_GRAINS_BALANCES_TO_SALES",{filters:[new a("ContractNum",n.EQ,this._selectedApplication.ContractNum),new a("Plant",n.EQ,this._selectedApplicati+
on.Plant),new a("AppQuantity",n.GT,0)],success:function(i){try{this.getOwnerComponent().getModel("ApplicationsProperty").setData(i);this.refreshModel("ApplicationsProperty");t()}catch{e("Falha ao obter documentos de aplicação do centro")}}.bind(this),err+
or:function(){e("Falha ao obter documentos de aplicação do centro")}})}else{e("Selecione uma entrada válida para realizar a fixação")}})},_refreshViewData:function(){this.getOwnerComponent().getModel("ApplicationsProperty").setData({});this.getOwnerCompo+
nent().getModel("Fixation").oData=o.createLineFixation();this.getOwnerComponent().getModel("Application").setData({});this.refreshModel("ApplicationsProperty");this.refreshModel("Fixation");this.refreshModel("Application")},onFixation:function(){this._Pa+
ymentDateValidate().then(()=>{this._getDolarQuotation().then(()=>{this._getCommodityData().then(()=>{this._getApplicationData().then(()=>{this._getFuturePrice().then(()=>{this._fixationPopupPrepare()}).catch(t=>{s.show(t,{icon:s.Icon.INFORMATION,title:"A+
viso"})})}).catch(t=>{s.show(t,{icon:s.Icon.INFORMATION,title:"Aviso"})})}).catch(t=>{s.show(t,{icon:s.Icon.INFORMATION,title:"Aviso"})})}).catch(t=>{s.show(t,{icon:s.Icon.INFORMATION,title:"Aviso"})})}).catch(t=>{s.show(t,{icon:s.Icon.INFORMATION,title:+
"Aviso"})})},_PaymentDateValidate:function(){return new Promise((t,e)=>{this._PaymentDate=this.getOwnerComponent().getModel("Fixation").getData().PaymentDate;this._NewPaymentDate=this._PaymentDate.split(".");this._NewPaymentDate=new Date(this._NewPayment+
Date[2],this._NewPaymentDate[1]-1,this._NewPaymentDate[0],23,59,59);if(this._NewPaymentDate instanceof Date&&!isNaN(this._NewPaymentDate)&&this._NewPaymentDate>=new Date){let i={Action:"DATEVALID",Json:JSON.stringify([{PaymentDate:this._PaymentDate.repla+
ceAll(".","")}]),StructureName:"ZADOS_GRAINS_PAYMENT_DATE"};this.getModel().create("/JsonCommunicationSet",i,{success:function(e){t()}.bind(this),error:function(t){e("Selecione uma data válida")}})}else{e("Selecione uma data válida")}})},_getDolarQuotati+
on:function(){return new Promise((t,e)=>{this.getModel().read("/ZADOC_GRAINS_DOLAR_QUOTATION",{success:function(i){try{this.getOwnerComponent().getModel("ConversionsModel").oData.DolarQuotation=i.results[0].Ukurs;this.refreshModel("ConversionsModel");t()+
}catch{e("Falha ao obter cotação do dólar")}}.bind(this),error:function(t){e("Falha ao obter cotação do dólar")}})})},_getCommodityData:function(){return new Promise((t,e)=>{this.getModel().read("/ZADOC_GRAINS_COMMODITY_DATA",{filters:[new a("CompanyCode+
",n.EQ,this.getOwnerComponent().getModel("ContractDetailsModel").getData().CompanyCode),new a("AppCode",n.EQ,"ACMCONTROL"),new a("Commodity",n.EQ,this.getOwnerComponent().getModel("ContractDetailsModel").getData().MaterialNum)],success:function(i){try{th+
is.getOwnerComponent().getModel("ConversionsModel").oData.CommodityFactor=i.results[0].ConversionFactor;this.getOwnerComponent().getModel("ConversionsModel").oData.RoyaltiesBlockPerc=i.results[0].RoyaltiesBlockPerc;t()}catch{e("Falha ao obter dados da co+
mmodity")}}.bind(this),error:function(t){e("Falha ao obter dados da commodity")}})})},_getFuturePrice:function(){this._NewPaymentDate.setDate(this._NewPaymentDate.getDate()-1);let t=new Date;return new Promise((e,i)=>{this.getModel().read("/ZADOC_GRAINS_+
FUTURE_PRICE",{filters:[new a("Commodity",n.EQ,this.getOwnerComponent().getModel("ContractDetailsModel").getData().MaterialNum),new a("Plant",n.EQ,this._selectedApplication.Plant),new a("CompanyCode",n.EQ,this.getOwnerComponent().getModel("ContractDetail+
sModel").getData().CompanyCode),new a("DueDate",n.GE,this._NewPaymentDate),new a("PriceDate",n.EQ,t)],sorters:[new r("DueDate",false)],success:function(t){try{this.getOwnerComponent().getModel("Fixation").oData.FuturePrice=t.results[0].Price;this.getOwne+
rComponent().getModel("Fixation").oData.DueCode=t.results[0].DueCode;this.getOwnerComponent().getModel("Fixation").oData.AvailableQuantity=this.getView().getModel("Application").getData().AvailableQuantity;this.refreshModel("Fixation");this._NewPaymentDa+
te.setDate(this._NewPaymentDate.getDate()+1);e()}catch{i("Falha ao obter preço futuro")}}.bind(this),error:function(t){this._NewPaymentDate.setDate(this._NewPaymentDate.getDate()+1);i("Falha ao obter preço futuro")}})})},_fixationPopupPrepare:function(){+
if(this.getView().getModel("Application").getData().TotalQuantity>0){if(this.getOwnerComponent().getModel("ConversionsModel").getData().DolarQuotation>0){if(this.getOwnerComponent().getModel("Fixation").oData.FuturePrice>0){this._showFixationPopup()}else+
{s.show("Não foi possível estabelecer o preço futuro",{icon:s.Icon.INFORMATION,title:"Aviso"})}}else{s.show("Não foi possível estabelecer a cotação do dólar",{icon:s.Icon.INFORMATION,title:"Aviso"})}}else{s.show("Selecione uma propriedade com saldo para +
realizar a fixação",{icon:s.Icon.INFORMATION,title:"Aviso"})}},_showFixationPopup:function(){this.getOwnerComponent().getModel("Fixation").getData().AvailableQuantity=this.getView().getModel("Application").getData().TotalQuantity;this.refreshModel("Fixat+
ion");if(!this._SalesFixationFragment){this._SalesFixationFragment=l.load({id:this.getView().getId(),name:"grains.zadograinsacmcontrolling.view.fragments.SalesFixation",controller:this}).then(function(t){this.getView().addDependent(t);return t}.bind(this+
))}this._SalesFixationFragment.then(function(t){t.open()})},onSaveFixation:function(t){if(this._fixationPopUpValidate().isValid){this.byId("MessageStrip").setVisible(false);let t=this.getOwnerComponent().getModel("Fixation").getData();this._updateApplica+
tionsTable(t.Quantity);this._CommodityConversionFactor=this.getOwnerComponent().getModel("ConversionsModel").getData().CommodityFactor;this._DolarQuotation=this.getOwnerComponent().getModel("ConversionsModel").getData().DolarQuotation;t.Amount=t.BagPrice+
[0]/60*t.Quantity;t.BasisPrice=this._toNumber(t.BagPrice[0])/this._DolarQuotation/this._CommodityConversionFactor-this._toNumber(t.FuturePrice);this.getOwnerComponent().getModel("Fixation").setData(t);this.getOwnerComponent().getModel("Fixation").refresh+
(true);this.getOwnerComponent().getModel("ConversionsModel").refresh(true);this.byId("FixationDialog").close()}else{this.byId("MessageStrip").setType(this._fixationPopUpValidate().State);this.byId("MessageStrip").setText(this._fixationPopUpValidate().Mes+
sage);this.byId("MessageStrip").setVisible(true)}},_updateApplicationsTable:function(t){this.getOwnerComponent().getModel("ApplicationsProperty").getData().results.forEach(t=>{t.FinalQuantity=t.AvailableQuantity});this.getOwnerComponent().getModel("Appli+
cationsProperty").getData().results.forEach(e=>{e.FinalQuantity=e.FinalQuantity-t;t=e.FinalQuantity<0?e.FinalQuantity*-1:"0";e.FinalQuantity=e.FinalQuantity>0?e.FinalQuantity:"0"});this.refreshModel("ApplicationsProperty");this.refreshModel("Fixation")},+
onCloseFixation:function(t){this._getApplicationData();this.getOwnerComponent().getModel("Fixation").setData(o.createLineFixation());this.refreshModel("Fixation");this.byId("MessageStrip").setVisible(false);this.byId("FixationDialog").close()},_fixationP+
opUpValidate:function(){let t=this.getOwnerComponent().getModel("Fixation").getData();let e=true;let i="";let o="";if(t.BagPrice[0]<1||t.Quantity<1){e=false;i="Error";o="Quantidade ou preço fornecido é inválido"}else if(parseFloat(t.Quantity)>parseFloat(+
t.AvailableQuantity)){e=false;i="Error";o="Quantidade fornecida é superior ao saldo disponível para propriedade"}return{isValid:e,State:i,Message:o}},_toNumber:function(t){t=t.toString();return parseFloat(t.replace(",","."))},onCreateFixation:function(){+
this._fixationValidate().then(()=>{let t=this._getFixationData();this._Send(t)}).catch(t=>{c.show(t)})},_fixationValidate(){return new Promise((t,e)=>{try{this._FixationData=this.getOwnerComponent().getModel("Fixation").getData();this._ApplicationsProper+
ty=this.getOwnerComponent().getModel("ApplicationsProperty").getData();this._ContractData=this.getView().getModel("ContractDetailsModel").getData();this._DolarQuotation=this.getView().getModel("ConversionsModel").getData().DolarQuotation;if(this._Fixatio+
nData.Quantity<1||!this._FixationData.Quantity){throw"Quantidade é inválida"}if(this._FixationData.Amount<1||!this._FixationData.Amount){throw"Montante é inválida"}if(this._FixationData.Quantity<1||!this._FixationData.Quantity){throw"Quantidade é inválid+
a"}if(this._DolarQuotation<1||!this._DolarQuotation){throw"Cotação do dólar é inválido"}if(this._ApplicationsProperty.results.length<1||!this._ApplicationsProperty.results.length){throw"Saldo das aplicações é inválido"}t()}catch(t){e(t)}})},_getFixationD+
ata:function(){var t=[];debugger;try{this._ApplicationsProperty.results.forEach(e=>{t.push({ApplicationDoc:e.ApplicationDoc,EdcNum:e.Edc,ApplicationQuantity:e.AvailableQuantity-e.FinalQuantity,Measure:"KG"})});this._FixationObject=JSON.stringify([{Plant:+
this._selectedApplication.Plant,Contract:this._ContractData.ContractNum,Identification:this._ContractData.IdentificationFix,Quantity:this._FixationData.Quantity,Unit:"KG",Material:this._ContractData.Material,MaterialNum:this._ContractData.MaterialNum,Bag+
Price:this._FixationData.BagPrice[0],Currency:this._FixationData.Currency,BasisPrice:parseFloat(this._FixationData.BasisPrice.toFixed(4)),FuturePrice:this._FixationData.FuturePrice,Amount:this._FixationData.Amount,KeydateCode:this._FixationData.DueCode,P+
aymentDate:this._FixationData.PaymentDate.replaceAll(".",""),DolarQuotation:this._DolarQuotation,ApplicationData:t}]);return{Action:"SALESFIX",Json:this._FixationObject,StructureName:"ZADOS_GRAINS_CREATE_FIXATION"}}catch{s.show("Dados da fixação incomple+
tos",{icon:s.Icon.INFORMATION,title:"Aviso"})}},_Send:function(t){sap.ui.core.BusyIndicator.show();this.getModel().create("/JsonCommunicationSet",t,{success:function(){let t=this.fillMessagesModel();this.MessageBarChangeVisible(true);this._refreshViewDat+
a();sap.ui.core.BusyIndicator.hide();if(t){c.show("Ocorreram erros no processo")}else{c.show("Processo executado com sucesso");setTimeout(function(){this.getRouter().navTo("RouteContractDetails",{Contract:this.getOwnerComponent().getModel("ContractDetail+
sModel").getData().ContractNum})}.bind(this),1e3)}}.bind(this),error:function(){let t=this.fillMessagesModel();this.MessageBarChangeVisible(true);this._refreshViewData();sap.ui.core.BusyIndicator.hide();c.show("Houve um erro interno")}.bind(this)})},onLi+
quidation:function(t){try{let t=this.getView().getObjectBinding().getPath();let e=this.getView().getModel().getData(t);if(e.FixationStatus!=="T")throw"Não é possível realizar a liquidação, fixação não aprovada";sap.ui.core.BusyIndicator.show();this._send+
Liquidation(e).then(t=>{let e=this.fillMessagesModel();this.MessageBarChangeVisible(true);sap.ui.core.BusyIndicator.hide();if(e){c.show("Aconteceram erros no processo, visualizar mensagens")}else{c.show("Processo executado com sucesso!")}}).catch(t=>{let+
 e=this.fillMessagesModel();this.MessageBarChangeVisible(true);sap.ui.core.BusyIndicator.hide();c.show("Houve um erro interno")})}catch(t){c.show("Falha ao efetuar a liquidação")}},_sendLiquidation:function(t){return new Promise((e,i)=>{try{var o={Action+
:"LIQUIDATE",Json:JSON.stringify([{Contract:t.ContractNum,Identification:t.FixationId}]),StructureName:"ZADOS_GRAINS_CREATE_FIXATION"}}catch{i()}this.getModel().create("/JsonCommunicationSet",o,{success:function(t){e()}.bind(this),error:function(t){i()}.+
bind(this)})})},onPrintForm:function(t){let e=this.getView().getModel().getData(this.getStorage("Fixation").sPath);this._PreviewSmartform(this.getView(),"ZADOSF_GRAINS_BOL_FIX_SELL",{contract_num:e.ContractNum,plant_nr:e.Plant,idnum:e.FixationId})}})});  