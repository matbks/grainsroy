sap.ui.define([                                                                                                                                                                                                                                                
    "sap/ui/core/mvc/Controller",                                                                                                                                                                                                                              
    "sap/ui/core/UIComponent",                                                                                                                                                                                                                                 
    "grains/zadograinsacmcontrolling/model/models",                                                                                                                                                                                                            
    "sap/ui/core/routing/History",                                                                                                                                                                                                                             
    "sap/m/PDFViewer",                                                                                                                                                                                                                                         
], function (                                                                                                                                                                                                                                                  
    Controller,                                                                                                                                                                                                                                                
    UIComponent,                                                                                                                                                                                                                                               
    models,                                                                                                                                                                                                                                                    
    History,                                                                                                                                                                                                                                                   
    PDFViewer                                                                                                                                                                                                                                                  
) {                                                                                                                                                                                                                                                            
    "use strict";                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    return Controller.extend("grains.zadograinsacmcontrolling.controller.BaseController", {                                                                                                                                                                    
                                                                                                                                                                                                                                                               
        getRouter: function () {                                                                                                                                                                                                                               
            return UIComponent.getRouterFor(this);                                                                                                                                                                                                             
        },                                                                                                                                                                                                                                                     
        getModel: function () {                                                                                                                                                                                                                                
            return new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZADOP_GRAINS_SRV")                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        getStorage: function (name) {                                                                                                                                                                                                                          
            return jQuery.sap.storage(jQuery.sap.storage.Type.local).get(name)                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        putStorage: function (name, obj) {                                                                                                                                                                                                                     
            jQuery.sap.storage(jQuery.sap.storage.Type.local).put(name, obj)                                                                                                                                                                                   
        },                                                                                                                                                                                                                                                     
        refreshModel: function (ModelName) {                                                                                                                                                                                                                   
            this.getOwnerComponent().getModel(ModelName).refresh(true)                                                                                                                                                                                         
        },                                                                                                                                                                                                                                                     
        onNavBack: function () {                                                                                                                                                                                                                               
            if (!History.getInstance().getPreviousHash()) {                                                                                                                                                                                                    
                window.history.go(-1)                                                                                                                                                                                                                          
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
        MessageBarChangeVisible: function (Visible) {                                                                                                                                                                                                          
            this.getOwnerComponent().getModel("MessagesModel").oData.MessageBar = Visible                                                                                                                                                                      
            this.refreshModel("MessagesModel")                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        initMessageProcessor: function () {                                                                                                                                                                                                                    
            let oMessageProcessor = new sap.ui.core.message.ControlMessageProcessor();                                                                                                                                                                         
            this._oMessageManager = sap.ui.getCore().getMessageManager();                                                                                                                                                                                      
            this._oMessageManager.registerMessageProcessor(oMessageProcessor);                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        fillMessagesModel: function () {                                                                                                                                                                                                                       
            let error = false                                                                                                                                                                                                                                  
            this._oMessageManager.getMessageModel().getData().forEach(element => {                                                                                                                                                                             
                if (element.message != '') {                                                                                                                                                                                                                   
                    error = element.type == "Error" ? true : error                                                                                                                                                                                             
                    this.getOwnerComponent().getModel("MessagesModel").getData().Messages.push(element)                                                                                                                                                        
                }                                                                                                                                                                                                                                              
            })                                                                                                                                                                                                                                                 
            return error                                                                                                                                                                                                                                       
        },                                                                                                                                                                                                                                                     
        clearMessageManager: function () {                                                                                                                                                                                                                     
            this._oMessageManager.removeAllMessages()                                                                                                                                                                                                          
        },                                                                                                                                                                                                                                                     
        _PreviewSmartform: function (oView, FormName, Params) {                                                                                                                                                                                                
            var Viewer = new PDFViewer();                                                                                                                                                                                                                      
            oView.addDependent(Viewer);                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
            let oModel = this.getModel()                                                                                                                                                                                                                       
            let sPath = oModel.createKey("/Print_SmartformSet", {                                                                                                                                                                                              
                FormName: FormName,                                                                                                                                                                                                                            
                FormParams: JSON.stringify(Params),                                                                                                                                                                                                            
            });                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            let sSource = oView.getModel().sServiceUrl + sPath + "/$value";                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
            Viewer.setShowDownloadButton(false);                                                                                                                                                                                                               
            Viewer.setSource(sSource);                                                                                                                                                                                                                         
            Viewer.setTitle("Boletim");                                                                                                                                                                                                                        
            Viewer.open();                                                                                                                                                                                                                                     
        },                                                                                                                                                                                                                                                     
        authValidate: function (Authorization) {                                                                                                                                                                                                               
            return new Promise((resolve, reject) => {                                                                                                                                                                                                          
                this.getModel().create("/JsonCommunicationSet", {                                                                                                                                                                                              
                    Action: "CHECK_AUTH",                                                                                                                                                                                                                      
                    Json: JSON.stringify([Authorization]),                                                                                                                                                                                                     
                    StructureName: "ZADOS_GRAINS_AUTH"                                                                                                                                                                                                         
                }, {                                                                                                                                                                                                                                           
                    success: function (oData) {                                                                                                                                                                                                                
                        resolve(oData)                                                                                                                                                                                                                         
                    }.bind(this),                                                                                                                                                                                                                              
                    error: function (oError) {                                                                                                                                                                                                                 
                        reject(oError)                                                                                                                                                                                                                         
                    }.bind(this)                                                                                                                                                                                                                               
                })                                                                                                                                                                                                                                             
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        callTransactionWithAdditionalURL(                                                                                                                                                                                                                      
            semanticObject,                                                                                                                                                                                                                                    
            action,                                                                                                                                                                                                                                            
            additionalUrl                                                                                                                                                                                                                                      
        ) {                                                                                                                                                                                                                                                    
            sap.ushell.Container.getServiceAsync(                                                                                                                                                                                                              
                "CrossApplicationNavigation"                                                                                                                                                                                                                   
            ).then(function (oService) {                                                                                                                                                                                                                       
                var sHref = oService.hrefForExternal({                                                                                                                                                                                                         
                    target: {                                                                                                                                                                                                                                  
                        semanticObject: semanticObject,                                                                                                                                                                                                        
                        action: action,                                                                                                                                                                                                                        
                    },                                                                                                                                                                                                                                         
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                sHref = sHref + additionalUrl;                                                                                                                                                                                                                 
                var sUrl = window.location.href.split("#")[0] + sHref;                                                                                                                                                                                         
                sap.m.URLHelper.redirect(sUrl, false);                                                                                                                                                                                                         
                // alert(sUrl);                                                                                                                                                                                                                                
            });                                                                                                                                                                                                                                                
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        callTransaction(semanticObject, action, params) {                                                                                                                                                                                                      
            var oService = sap.ushell.Container.getService("CrossApplicationNavigation");                                                                                                                                                                      
            var sHref = oService.hrefForExternal({                                                                                                                                                                                                             
                target: {                                                                                                                                                                                                                                      
                    semanticObject: semanticObject,                                                                                                                                                                                                            
                    action: action                                                                                                                                                                                                                             
                },                                                                                                                                                                                                                                             
                params: params                                                                                                                                                                                                                                 
            });                                                                                                                                                                                                                                                
            window.location.href = sHref;                                                                                                                                                                                                                      
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
    });                                                                                                                                                                                                                                                        
});                                                                                                                                                                                                                                                            