sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/model/FilterOperator","sap/m/GroupHeaderListItem","sap/ui/Device","sap/ui/core/Fragment","../model/formatter","sap/m/MessageToast","sap/ui+
/vk/Material","./RedwareTools/ValueHelp/ValueHelp","sap/ui/core/UIComponent","sap/m/SearchField","sap/ui/model/type/String","royalties/zroyalties/controller/GetBalance"],function(e,t,i,a,r,o,n,s,l,c,d,h,u,g,p,f){"use strict";return e.extend("royalties.zr+
oyalties.controller.List",{formatter:l,onInit:function(){this.getView().addEventDelegate({onAfterShow:function(e){this.byId("st_monitor").getTable().removeSelections()}.bind(this)},this.getView());var e=this.byId("list"),t=this._createViewModel(),i=e.get+
BusyIndicatorDelay();this._oList=e;this._oListFilterState={aFilter:[],aSearch:[]};this.setModel(t,"listView");e.attachEventOnce("updateFinished",function(){t.setProperty("/delay",i)});this.getView().addEventDelegate({onBeforeFirstShow:function(){this.get+
OwnerComponent().oListSelector.setBoundMasterList(e)}.bind(this)});this.getRouter().getRoute("list").attachPatternMatched(this._onMasterMatched,this);this.getRouter().attachBypassed(this.onBypassed,this);this.setSmartTable("st_monitor")},onUpdateFinished+
:function(e){this._updateListItemCount(e.getParameter("total"))},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh();return}var t=e.getParameter("query");if(t){this._oListFilterState.aSearch=[new i("EdcNum",r.Contains,t)]}els+
e{this._oListFilterState.aSearch=[]}this._applyFilterSearch()},onRefresh:function(){this._oList.getBinding("items").refresh()},onPartnerSelected:function(e){var t=this.getView().getModel("RadioButtons");var i=e.getParameter("selected");t.setProperty("/Pa+
rceiro",i);t.setProperty("/Contrato",!i);this.getView().byId("Contract").setValue("")},onContractSelected:function(e){var t=this.getView().getModel("RadioButtons");var i=e.getParameter("selected");t.setProperty("/Parceiro",!i);t.setProperty("/Contrato",i+
);this.getView().byId("Partner").setValue("")},onOpenViewSettings:function(e){var t="filter";if(e.getSource()instanceof sap.m.Button){var i=e.getSource().getId();if(i.match("sort")){t="sort"}else if(i.match("group")){t="group"}}if(!this.byId("viewSetting+
sDialog")){s.load({id:this.getView().getId(),name:"royalties.zroyalties.view.ViewSettingsDialog",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open(t)}.bind(this))}e+
lse{this.byId("viewSettingsDialog").open(t)}},onConfirmViewSettingsDialog:function(e){this._applySortGroup(e)},_applySortGroup:function(e){var t=e.getParameters(),i,r,o=[];i=t.sortItem.getKey();r=t.sortDescending;o.push(new a(i,r));this._oList.getBinding+
("items").sort(o)},onSelectionChange:function(e){let t=this.getView().byId("st_monitor");let i=t.getTable();var a=i._aSelectedPaths;var r=i.getModel().getProperty(a.toString());var o=this.getView().getModel("Monitor");o.setData(r);var n=e.getSource(),s=e+
.getParameter("selected");if(!(n.getMode()==="MultiSelect"&&!s)){this._showDetail(e.getParameter("listItem")||e.getSource())}},onBypassed:function(){this._oList.removeSelections(true)},createGroupHeader:function(e){return new o({title:e.text,upperCase:fa+
lse})},onShowReport:function(e){var t=sap.ui.core.UIComponent.getRouterFor(this);t.navTo("report")},onMassDischarge:function(e){var t=this.getView();if(!this.byId("openDialog")){s.load({id:t.getId(),name:"royalties.zroyalties.view.fragments.MassDischarge+
",controller:this}).then(function(e){t.addDependent(e);e.open()})}else{this.byId("openDialog").open()}},onPartnerRefChange:function(e){var t=this.getView().getModel("listView");var i=t.getData();var a=e.getParameter("item").getKey();i.massDischarge.butto+
ns.partner.visible=false;i.massDischarge.buttons.CPF.visible=false;i.massDischarge.buttons.CNPJ.visible=false;i.massDischarge.buttons[a].visible=true;t.refresh();var r=this.byId(a);this._focusOnInputField(r)},onCpfCnpjChange:function(e){var t=e.getParame+
ter("newValue");var t=t.replace(/[.\-_\s]/g,"")},_focusOnInputField:function(e){e.getDomRef().focus()},handleCancelMassDischarge:function(){this.byId("Contract").mProperties.value="";this.byId("Partner").mProperties.value="";this.byId("Quantity").mProper+
ties.value="";this.byId("Protocol").mProperties.value="";this.byId("openDialog").destroy()},handleSaveMassDischarge:function(){var e=this.getView().getModel();var t=this.getView().byId("st_monitor");if((this.byId("Contract").mProperties.value!=""||this.b+
yId("Partner").mProperties.value!="")&&this.byId("Quantity").mProperties.value!=""&&this.byId("Protocol").mProperties.value!=""){if(parseFloat(this.byId("Quantity").mProperties.value)>parseFloat(this.byId("Balance").mProperties.value)){c.show("Selecione +
uma quantidade inferior ou igual ao total bloqueado")}else{var i=[{Contract:this.byId("Contract").mProperties.value,Partner:this.byId("Partner").mProperties.value,Quantity:this.byId("Quantity").mProperties.value,Protocol:this.byId("Protocol").mProperties+
.value}];var a={Action:"MASSDISCHARGE",Payload:JSON.stringify(i)};e.create("/JsonCommSet",a,{success:function(e,i){if(i.statusCode=="201"){var a=this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("discharged");c.show(a);t.rebindTable()+
;let e=this.getSmartTable("st_log");e.rebindTable();this.handleCancelMassDischarge()}}.bind(this),error:function(e){var t=JSON.parse(e.responseText);var i=t.error.message.value;c.show(i)}})}}else{c.show("Preencha o campo contrato ou parceiro")}},onDischa+
rge:function(e){let t=this.getView().byId("st_monitor");let i=t.getTable();var a=i._aSelectedPaths;if(a.length<1){c.show(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("nullRegisterNotAllowed"))}else{var r=i.getModel().getProperty(+
a.toString());var o=this.getView();var n=o.getModel("Monitor");n.setData(r);if(!this.byId("openDialog")){s.load({id:o.getId(),name:"royalties.zroyalties.view.fragments.Discharge",controller:this}).then(function(e){o.addDependent(e);e.open()})}else{this.b+
yId("openDialog").open()}}},handleSaveBtnPress:function(e){var t=this.getView().getModel("Monitor");var i=this.getView().getModel();var a=t.getData();var r=this.byId("dischargeInput").mProperties.value;var o=this.byId("balanceInput").mProperties.value;va+
r n=this.byId("Protocol").mProperties.value;var s=new Date;var l=s.getFullYear();var d={Plant:t.getData().Plant,Romaneio:t.getData().Romaneio,Edcnumber:t.getData().EdcNum,Discharge:r,Fiscalyear:l.toString(),Balance:o,Dischargestatus:"BAIXA MANUAL",Create+
don:new Date,Operation:"1",Protocol:n};i.create("/DischargeQtySet",d,{success:function(e,i){if(i.statusCode=="201"){var a=this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("discharged");c.show(a);this.clearModel(t);this.handleCancelBt+
nPress();this.model().refresh(true)}}.bind(this),error:function(e){var t=JSON.parse(e.responseText);var i=t.error.message.value;c.show(i)}})},handleCancelBtnPress:function(){this.byId("openDialog").close();var e=this.getView().getModel("Monitor");this.cl+
earModel(e)},clearModel:function(e){e.setData({EdcNum:"",ContractNum:"",ApplicationDocnum:"",EdcType:"",Property:"",Material:"",MaterialDescription:"",ApplicationQuantity:"",CreatedBy:"",CreatedOn:"",ChangeBy:"",ChangeOn:"",Ticket:"",Romaneio:"",TicketDa+
te:"",Partner:"",PartnerId:"",PropertyDescription:"",PartnerDescription:"",Safra:"",Plant:""})},onNavBack:function(){history.go(-1)},onPartnerF4:function(e){let t=h.createSearchHelp(this.getView(),"Parceiro","/ZADOC_ROYALTIES_PARTNERS","Partner","Partner+
Description",e.getSource());t.open()},onValueHelpPartnerRequested:function(){this._oBasicSearchField=new g({liveChange:this.onFilterBarSearch.bind(this)});if(!this.pDialog){this.pDialog=this.loadFragment("ValueHelpPartner",this.getView())}this.pDialog.th+
en(function(e){var t=e.getFilterBar();this._oVHD=e;if(this._bDialogInitialized){e.update();e.open();return}this.getView().addDependent(e);t.setFilterBarExpanded(false);t.setBasicSearch(this._oBasicSearchField);this._oBasicSearchField.attachSearch(functio+
n(){t.search()});e.getTableAsync().then(function(t){t.setModel(this.getView().getModel());if(t.bindRows){t.bindAggregation("rows",{path:"/ZADOC_ROYALTIES_PARTNERS",events:{dataReceived:function(){e.update()}}});t.addColumn(new sap.ui.table.Column({label:+
"Parceiro",template:"Partner",width:"100px"}));t.addColumn(new sap.ui.table.Column({label:"Nome do Parceiro",template:"PartnerDescription"}));t.addColumn(new sap.ui.table.Column({label:"CNPJ/CPF",template:new sap.m.Text({text:{parts:["CnpjOrCpf"],formatt+
er:this.formatCnpjCpf}})}))}if(t.bindItems){t.bindAggregation("items",{path:"/ZADOC_ROYALTIES_PARTNERS",template:new ColumnListItem({cells:[new Label({text:"{Partner}"}),new sap.m.Label({text:"{PartnerDescription}"})]}),events:{dataReceived:function(){e.+
update()}}});t.addColumn(new sap.m.Column({header:new sap.m.Label({text:"Parceiro"})}));t.addColumn(new sap.m.Column({header:new sap.m.Label({text:"Nome do Parceiro"})}))}e.update()}.bind(this));this._bDialogInitialized=true;e.open()}.bind(this))},format+
CnpjCpf:function(e){if(!e){return}if(e.length===11){return e.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4")}else if(e.length===14){return e.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,"$1.$2.$3/$4-$5")}else{return e}},onFilterBarSearch:function(+
e){var t=[];if(e.sId==="liveChange"){var a=e.getParameter("value");if(!a){var a=e.getParameter("newValue")}}else{var a=this._oBasicSearchField.getValue()}var o=e.getParameter("selectionSet");if(o){var t=o.reduce(function(e,t){if(t.getValue()){e.push(new +
i({path:t.getName(),operator:r.Contains,value1:t.getValue()}))}return e},[])}function n(e){const t=/^[0-9.\-\/]+$/;return t.test(e)}function s(e){const t=/[.\-\/]/g;return e.replace(t,"")}if(n(a)){a=s(a)}t.push(new i({filters:[new i({path:"Partner",opera+
tor:r.Contains,value1:a}),new i({path:"PartnerDescription",operator:r.Contains,value1:a}),new i({path:"CnpjOrCpf",operator:r.Contains,value1:a})],and:false}));this._filterTable(new i({filters:t,and:true}))},onValueHelpCancelPress:function(){this._oVHD.cl+
ose()},onValueHelpOkPress:function(e){var t=this.getView().getModel("listView");var i=e.getParameter("tokens");var a=i[0].getKey();t.setProperty("/massDischarge/popUpData/partner",a);if(a){new f("Parceiro",a,this.byId("Balance"),this.getView())}this._oVH+
D.close()},_filterTable:function(e){var t=this._oVHD;t.getTableAsync().then(function(i){if(i.bindRows){i.getBinding("rows").filter(e)}if(i.bindItems){i.getBinding("items").filter(e)}t.update()})},_addMaskToInput:function(e){var t=e.$().find("input");t.ma+
sk("000.000.000-00",{reverse:true,onKeyPress:function(e,i,a,r){var o=["000.000.000-000","00.000.000/0000-00"];var n=e.length>14?o[1]:o[0];t.mask(n,r)}})},onContractF4:function(e){let t=h.createSearchHelp(this.getView(),"Contrato","/ZADOC_ROYALTIES_CONTRA+
CTS","Contract","ContractDescription",e.getSource());t.open()},_createViewModel:function(){return new t({isFilterBarVisible:false,filterBarLabel:"",delay:0,title:this.getResourceBundle().getText("listTitleCount",[0]),noDataText:this.getResourceBundle().g+
etText("listListNoDataText"),sortBy:"EdcNum",groupBy:"None",massDischarge:{buttons:{partner:{visible:true},CPF:{visible:false},CNPJ:{visible:false}},popUpData:{partner:""}}})},_onMasterMatched:function(){this.getModel("appView").setProperty("/layout","On+
eColumn")},_showDetail:function(e){var t=!n.system.phone;this.getModel("appView").setProperty("/layout","TwoColumnsBeginExpanded");this.getRouter().navTo("object",{objectId:e.getBindingContext().getProperty("EdcNum")},t)},_updateListItemCount:function(e)+
{var t;if(this._oList.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("listTitleCount",[e]);this.getModel("listView").setProperty("/title",t)}},_applyFilterSearch:function(){var e=this._oListFilterState.aSearch.concat(this._oListF+
ilterState.aFilter),t=this.getModel("listView");this._oList.getBinding("items").filter(e,"Application");if(e.length!==0){t.setProperty("/noDataText",this.getResourceBundle().getText("listListNoDataWithFilterOrSearchText"))}else if(this._oListFilterState.+
aSearch.length>0){t.setProperty("/noDataText",this.getResourceBundle().getText("listListNoDataText"))}},_updateFilterBar:function(e){var t=this.getModel("listView");t.setProperty("/isFilterBarVisible",this._oListFilterState.aFilter.length>0);t.setPropert+
y("/filterBarLabel",this.getResourceBundle().getText("listFilterBarText",[e]))}})});                                                                                                                                                                           